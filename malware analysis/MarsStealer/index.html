<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Deep Analysis of Mars Stealer - XJunior</title>
<meta name="description" content="Mars Stealer is an improved copy of Oski Stealer.">


  <meta name="author" content="Mohamed Ashraf">
  
  <meta property="article:author" content="Mohamed Ashraf">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="XJunior">
<meta property="og:title" content="Deep Analysis of Mars Stealer">
<meta property="og:url" content="/malware%20analysis/MarsStealer/">


  <meta property="og:description" content="Mars Stealer is an improved copy of Oski Stealer.">



  <meta property="og:image" content="/assets/malware-analysis/Mars/logo1.gif">





  <meta property="article:published_time" content="2022-05-19T00:00:00+02:00">





  

  


<link rel="canonical" href="/malware%20analysis/MarsStealer/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Mohamed Ashraf",
      "url": "/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="XJunior Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/logo.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/logo.png">
<meta name="theme-color" content="#ffffff">

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/logo.png" alt="XJunior"></a>
        
        <a class="site-title" href="/">
          XJunior
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/#malware-analysis">Malware Analysis</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">All Categories</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/images/logo5.jpg" alt="Mohamed Ashraf" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Mohamed Ashraf</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Malware Analysis &amp; Reverse Engineering &amp; Cryptography</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Egypt</span>
        </li>
      

      
        
          
            <li><a href="mailto:malxjunior@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://twitter.com/X__Junior" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/X-Junior" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/x-junior/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://discordapp.com/users/537628178978570261" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-discord" aria-hidden="true"></i><span class="label">Discord</span></a></li>
          
        
          
            <li><a href="https://medium.com/@xjunior" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-medium" aria-hidden="true"></i><span class="label">Medium</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Deep Analysis of Mars Stealer">
    <meta itemprop="description" content="Introduction">
    <meta itemprop="datePublished" content="2022-05-19T00:00:00+02:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Deep Analysis of Mars Stealer
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  28 minute read

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#introduction">Introduction</a></li><li><a href="#overview">Overview</a></li><li><a href="#anti-analysis">Anti-Analysis</a></li><li><a href="#string-encryption">String Encryption</a></li><li><a href="#dynamic-linking">Dynamic linking</a></li><li><a href="#anti-sandbox">Anti-Sandbox</a></li><li><a href="#anti-cis">Anti-CIS</a></li><li><a href="#anti-emulation">Anti-Emulation</a></li><li><a href="#mutex">Mutex</a></li><li><a href="#anti-debug">Anti-Debug</a></li><li><a href="#expiration-check">Expiration check</a></li><li><a href="#main-functionality">Main Functionality</a><ul><li><a href="#understanding-configuration-format">Understanding Configuration Format</a></li><li><a href="#grabber">Grabber</a></li><li><a href="#browsers">Browsers</a></li><li><a href="#cryptocurrency-wallets-via-browser-extensions">Cryptocurrency Wallets via browser extensions</a></li><li><a href="#crypto-wallets">Crypto Wallets</a></li><li><a href="#system-info">System info</a></li><li><a href="#loader">Loader</a></li></ul></li><li><a href="#self-deletion">Self Deletion</a></li><li><a href="#generalized--idapython-script-using-patterns">Generalized  idapython Script using patterns</a></li><li><a href="#iocs">IOCs</a></li><li><a href="#yara">YARA</a></li><li><a href="#conclusion">Conclusion</a></li><li><a href="#references">References</a></li></ul>

            </nav>
          </aside>
        
        <h1 id="introduction">Introduction</h1>

<p>Mars Stealer is an improved copy of Oski Stealer. I saw alot of tweets recently about it so i decided to write an analysis of the newer version V8. Enjoy reading!</p>
<ul>
  <li>Diffrences from the previous version:
    <ol>
      <li>Anti analysis technique</li>
      <li>Diffrent encryption algoithm</li>
      <li>Introudcing new anti debug technique</li>
      <li>New configuration format</li>
      <li>External dlls are in one zip file</li>
    </ol>
  </li>
</ul>

<h1 id="overview">Overview</h1>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/overview.png" /> 
</p>
<h1 id="anti-analysis">Anti-Analysis</h1>

<p>Opening mars stealer in ida we can see an  anti-analysis trick called Opaque Predicates it’s a commonly used technique in program obfuscation, intended to add complexity to the control flow.</p>

<p>This obfuscation simply takes an absolute jump (JMP) and transforms it into two conditional jumps (JZ/JNZ). Depending on the value of the Zero flag (ZF), the execution will follow the first or second branch.</p>

<p>However, disassemblers are tricked into thinking that there is a fall-through branch if the second jump is not taken (which is impossible as one of them must be taken) and tries to disassemble the unreachable instructions (often invalid) resulting in garbage code.</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/1.png" /> 
</p>

<p>the deobfuscation is simple, we just need to patch the first conditional jump to an absolute jump and nop out the second jump, we can use IDAPython to achieve this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">idc</span>

<span class="n">ea</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">ea</span> <span class="o">=</span>  <span class="nb">min</span><span class="p">(</span><span class="n">ida_search</span><span class="p">.</span><span class="n">find_binary</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span><span class="n">idc</span><span class="p">.</span><span class="n">BADADDR</span><span class="p">,</span> <span class="s">"74 ? 75 ?"</span><span class="p">,</span><span class="mi">16</span> <span class="p">,</span><span class="n">idc</span><span class="p">.</span><span class="n">SEARCH_NEXT</span> <span class="o">|</span> <span class="n">idc</span><span class="p">.</span><span class="n">SEARCH_DOWN</span><span class="p">),</span>  <span class="c1"># JZ / JNZ
</span>    <span class="n">ida_search</span><span class="p">.</span><span class="n">find_binary</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span><span class="n">idc</span><span class="p">.</span><span class="n">BADADDR</span><span class="p">,</span> <span class="s">"75 ? 74 ?"</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span> <span class="n">idc</span><span class="p">.</span><span class="n">SEARCH_NEXT</span> <span class="o">|</span> <span class="n">idc</span><span class="p">.</span><span class="n">SEARCH_DOWN</span><span class="p">))</span>  <span class="c1"># JNZ / JZ
</span>    <span class="k">if</span> <span class="n">ea</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">BADADDR</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">idc</span><span class="p">.</span><span class="n">patch_byte</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mh">0xEB</span><span class="p">)</span>
    <span class="n">idc</span><span class="p">.</span><span class="n">patch_byte</span><span class="p">(</span><span class="n">ea</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">)</span>
    <span class="n">idc</span><span class="p">.</span><span class="n">patch_byte</span><span class="p">(</span><span class="n">ea</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">)</span>
    <span class="n">idc</span><span class="p">.</span><span class="n">patch_byte</span><span class="p">(</span><span class="n">ea</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">)</span>
</code></pre></div></div>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/2.png" /> 
</p>
<center><font size="3"> <u>After Running the Script </u></font> </center>

<p>now we can see a clear view , after reversing and renaming</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/malware-analysis/Mars/3.png"><img src="/assets/malware-analysis/Mars/3.png" alt="0" /></a></td>
      <td><a href="/assets/malware-analysis/Mars/3-2.png"><img src="/assets/malware-analysis/Mars/3-2.png" alt="0" /></a></td>
    </tr>
  </tbody>
</table>

<p>First Mars get a handle to kernel32.dll by parsing <code class="language-plaintext highlighter-rouge">InLoadOrderModuleList</code> then it passes the handle to a fucntion that  loops over the exported functions of the DLL to get the address of the <code class="language-plaintext highlighter-rouge">LocalAlloc()</code> and <code class="language-plaintext highlighter-rouge">VirtualProtect()</code> functions.</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/4.png" /> 
</p>
<h1 id="string-encryption">String Encryption</h1>
<p>After that it decrypts some strings used for some checks , the decryption is a simple xor function</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/5.png" /> 
</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/6.png" /> 
</p>

<p>We can although see that the xor function is refrenced in another function which i renamed as Decrypt_String_2 if the malware passes the checks which we will see soon it decrypt those string which contanis strings needed for the malware to steal sensitive data .</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/8.png" /> 
</p>

<p>We use idapython script to get those strings and rename the variables to make reversing easier</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/7.png" /> 
</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">string</span>

<span class="k">def</span> <span class="nf">sanitize_string</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">name</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_letters</span><span class="p">])[:</span><span class="mi">20</span><span class="p">].</span><span class="n">capitalize</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">X0r</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="n">start_Addrs</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x00401770</span><span class="p">,</span><span class="mh">0x00401990</span>  <span class="p">]</span>
<span class="n">end_Addrs</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x00401967</span><span class="p">,</span><span class="mh">0x0405444</span> <span class="p">]</span>

<span class="n">string_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">dectypred_data</span> <span class="o">=</span> <span class="sa">b</span><span class="s">''</span>
<span class="n">addrs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start_Addrs</span><span class="p">)):</span>
    <span class="n">ea</span> <span class="o">=</span> <span class="n">start_Addrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">end_Addrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">while</span> <span class="n">ea</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">o_imm</span><span class="p">:</span>
            <span class="n">addrs</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">addrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">addrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="n">addrs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">length</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="n">addrs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">length</span><span class="p">)</span>
            <span class="n">dectypred_data</span> <span class="o">=</span> <span class="n">X0r</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
            <span class="n">string_list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">dectypred_data</span><span class="p">)</span>
            <span class="n">addrs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">idc</span><span class="p">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">==</span> <span class="s">"call"</span><span class="p">:</span>
            <span class="n">idc</span><span class="p">.</span><span class="n">set_cmt</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">dectypred_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">idc</span><span class="p">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">==</span> <span class="s">"mov"</span> <span class="ow">and</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">o_mem</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">idc</span><span class="p">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">o_reg</span><span class="p">):</span>
            <span class="n">global_var</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">idc</span><span class="p">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">global_var</span><span class="p">,</span> <span class="s">"Str"</span> <span class="o">+</span> <span class="n">sanitize_string</span><span class="p">(</span><span class="n">dectypred_data</span><span class="p">),</span> <span class="n">SN_NOWARN</span><span class="p">)</span>

        <span class="n">ea</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">next_head</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>


</code></pre></div></div>

<p>Here is a list of the decrypted strings :</p>

<details style="color: #EEFFFF; font-family: monospace !default; font-size: 0.85em; background: #263238; border: 1px solid #263238; border-radius: 3px; padding: 10px; line-height: 2.2; overflow-x: scroll;">
    <summary style="outline: none; cursor: pointer">
        <span style="color: darkgray">
            Expand to see more
        </span><br />
<div style="height: 1px"></div>
&emsp; LoadLibraryA<br />
&emsp; GetProcAddress<br />
&emsp; ExitProcess<br />
&emsp; advapi32.dll<br />
&emsp; crypt32.dll<br />
&emsp; GetTickCount<br />
&emsp; Sleep<br />
&emsp; GetUserDefaultLangID<br />
&emsp; CreateMutexA<br />
&emsp; GetLastError<br />
</summary>
&emsp; HeapAlloc<br />
&emsp; GetProcessHeap<br />
&emsp; GetComputerNameA<br />
&emsp; VirtualProtect<br />
&emsp; GetCurrentProcess<br />
&emsp; VirtualAllocExNuma<br />
&emsp; GetUserNameA<br />
&emsp; CryptStringToBinaryA<br />
&emsp; HAL9TH<br />
&emsp; JohnDoe<br />
&emsp; ­6Ê§È/2022 20:00:00<br />
&emsp; http://<br />
&emsp; 194.87.218.39<br />
&emsp; 92550737836278980100<br />
&emsp; /RyC66VfSGP.php<br />
&emsp; Default<br />
&emsp; %hu/%hu/%hu %hu:%hu:%hu<br />
&emsp; open<br />
&emsp; sqlite3.dll<br />
&emsp; C:\ProgramData\sqlite3.dll<br />
&emsp; freebl3.dll<br />
&emsp; C:\ProgramData\freebl3.dll<br />
&emsp; mozglue.dll<br />
&emsp; C:\ProgramData\mozglue.dll<br />
&emsp; msvcp140.dll<br />
&emsp; C:\ProgramData\msvcp140.dll<br />
&emsp; nss3.dll<br />
&emsp; C:\ProgramData\nss3.dll<br />
&emsp; softokn3.dll<br />
&emsp; C:\ProgramData\softokn3.dll<br />
&emsp; vcruntime140.dll<br />
&emsp; C:\ProgramData\vcruntime140.dll<br />
&emsp; .zip<br />
&emsp; Tag: <br />
&emsp; IP: IP?<br />
&emsp; Country: Country?<br />
&emsp; Working Path: <br />
&emsp; Local Time: <br />
&emsp; TimeZone: <br />
&emsp; Display Language: <br />
&emsp; Keyboard Languages: <br />
&emsp; Is Laptop: <br />
&emsp; Processor: <br />
&emsp; Installed RAM: <br />
&emsp; OS: <br />
&emsp;  (<br />
&emsp;  Bit)<br />
&emsp; Videocard: <br />
&emsp; Display Resolution: <br />
&emsp; PC name: <br />
&emsp; User name: <br />
&emsp; Domain name: <br />
&emsp; MachineID: <br />
&emsp; GUID: <br />
&emsp; Installed Software: <br />
&emsp; system.txt<br />
&emsp; Grabber\%s.zip<br />
&emsp; %APPDATA%<br />
&emsp; %LOCALAPPDATA%<br />
&emsp; %USERPROFILE%<br />
&emsp; %DESKTOP%<br />
&emsp; Wallets\<br />
&emsp; Ethereum<br />
&emsp; \Ethereum\<br />
&emsp; keystore<br />
&emsp; Electrum<br />
&emsp; \Electrum\wallets\<br />
&emsp; *.*<br />
&emsp; ElectrumLTC<br />
&emsp; \Electrum-LTC\wallets\<br />
&emsp; Exodus<br />
&emsp; \Exodus\<br />
&emsp; exodus.conf.json<br />
&emsp; window-state.json<br />
&emsp; \Exodus\exodus.wallet\<br />
&emsp; passphrase.json<br />
&emsp; seed.seco<br />
&emsp; info.seco<br />
&emsp; ElectronCash<br />
&emsp; \ElectronCash\wallets\<br />
&emsp; default_wallet<br />
&emsp; MultiDoge<br />
&emsp; \MultiDoge\<br />
&emsp; multidoge.wallet<br />
&emsp; JAXX<br />
&emsp; \jaxx\Local Storage\<br />
&emsp; file__0.localstorage<br />
&emsp; Atomic<br />
&emsp; \atomic\Local Storage\leveldb\<br />
&emsp; 000003.log<br />
&emsp; CURRENT<br />
&emsp; LOCK<br />
&emsp; LOG<br />
&emsp; MANIFEST-000001<br />
&emsp; 0000*<br />
&emsp; Binance<br />
&emsp; \Binance\<br />
&emsp; app-store.json<br />
&emsp; Coinomi<br />
&emsp; \Coinomi\Coinomi\wallets\<br />
&emsp; *.wallet<br />
&emsp; *.config<br />
&emsp; *wallet*.dat<br />
&emsp; GetSystemTime<br />
&emsp; lstrcatA<br />
&emsp; SystemTimeToFileTime<br />
&emsp; ntdll.dll<br />
&emsp; sscanf<br />
&emsp; memset<br />
&emsp; memcpy<br />
&emsp; wininet.dll<br />
&emsp; user32.dll<br />
&emsp; gdi32.dll<br />
&emsp; netapi32.dll<br />
&emsp; psapi.dll<br />
&emsp; bcrypt.dll<br />
&emsp; vaultcli.dll<br />
&emsp; shlwapi.dll<br />
&emsp; shell32.dll<br />
&emsp; gdiplus.dll<br />
&emsp; ole32.dll<br />
&emsp; dbghelp.dll<br />
&emsp; CreateFileA<br />
&emsp; WriteFile<br />
&emsp; CloseHandle<br />
&emsp; GetFileSize<br />
&emsp; lstrlenA<br />
&emsp; LocalAlloc<br />
&emsp; GlobalFree<br />
&emsp; ReadFile<br />
&emsp; OpenProcess<br />
&emsp; SetFilePointer<br />
&emsp; SetEndOfFile<br />
&emsp; GetCurrentProcessId<br />
&emsp; GetLocalTime<br />
&emsp; GetTimeZoneInformation<br />
&emsp; GetUserDefaultLocaleName<br />
&emsp; LocalFree<br />
&emsp; GetSystemPowerStatus<br />
&emsp; GetSystemInfo<br />
&emsp; GlobalMemoryStatusEx<br />
&emsp; IsWow64Process<br />
&emsp; GetTempPathA<br />
&emsp; GetLocaleInfoA<br />
&emsp; GetFileSizeEx<br />
&emsp; GetFileAttributesA<br />
&emsp; FindFirstFileA<br />
&emsp; FindNextFileA<br />
&emsp; FindClose<br />
&emsp; GetCurrentDirectoryA<br />
&emsp; CopyFileA<br />
&emsp; DeleteFileA<br />
&emsp; lstrcmpW<br />
&emsp; GlobalAlloc<br />
&emsp; FreeLibrary<br />
&emsp; SetCurrentDirectoryA<br />
&emsp; CreateFileMappingA<br />
&emsp; MapViewOfFile<br />
&emsp; UnmapViewOfFile<br />
&emsp; FileTimeToSystemTime<br />
&emsp; GetFileInformationByHandle<br />
&emsp; GlobalLock<br />
&emsp; GlobalSize<br />
&emsp; WideCharToMultiByte<br />
&emsp; GetWindowsDirectoryA<br />
&emsp; GetVolumeInformationA<br />
&emsp; GetVersionExA<br />
&emsp; GetModuleFileNameA<br />
&emsp; CreateFileW<br />
&emsp; CreateFileMappingW<br />
&emsp; MultiByteToWideChar<br />
&emsp; CreateThread<br />
&emsp; GetEnvironmentVariableA<br />
&emsp; SetEnvironmentVariableA<br />
&emsp; lstrcpyA<br />
&emsp; lstrcpynA<br />
&emsp; InternetOpenA<br />
&emsp; InternetConnectA<br />
&emsp; HttpOpenRequestA<br />
&emsp; HttpSendRequestA<br />
&emsp; HttpQueryInfoA<br />
&emsp; InternetCloseHandle<br />
&emsp; InternetReadFile<br />
&emsp; InternetSetOptionA<br />
&emsp; InternetOpenUrlA<br />
&emsp; InternetCrackUrlA<br />
&emsp; wsprintfA<br />
&emsp; CharToOemW<br />
&emsp; GetKeyboardLayoutList<br />
&emsp; EnumDisplayDevicesA<br />
&emsp; ReleaseDC<br />
&emsp; GetDC<br />
&emsp; GetSystemMetrics<br />
&emsp; GetDesktopWindow<br />
&emsp; GetWindowRect<br />
&emsp; GetWindowDC<br />
&emsp; CloseWindow<br />
&emsp; RegOpenKeyExA<br />
&emsp; RegQueryValueExA<br />
&emsp; RegCloseKey<br />
&emsp; GetCurrentHwProfileA<br />
&emsp; RegEnumKeyExA<br />
&emsp; RegGetValueA<br />
&emsp; CreateDCA<br />
&emsp; GetDeviceCaps<br />
&emsp; CreateCompatibleDC<br />
&emsp; CreateCompatibleBitmap<br />
&emsp; SelectObject<br />
&emsp; BitBlt<br />
&emsp; DeleteObject<br />
&emsp; StretchBlt<br />
&emsp; GetObjectW<br />
&emsp; GetDIBits<br />
&emsp; SaveDC<br />
&emsp; CreateDIBSection<br />
&emsp; DeleteDC<br />
&emsp; RestoreDC<br />
&emsp; DsRoleGetPrimaryDomainInformation<br />
&emsp; GetModuleFileNameExA<br />
&emsp; CryptUnprotectData<br />
&emsp; BCryptCloseAlgorithmProvider<br />
&emsp; BCryptDestroyKey<br />
&emsp; BCryptOpenAlgorithmProvider<br />
&emsp; BCryptSetProperty<br />
&emsp; BCryptGenerateSymmetricKey<br />
&emsp; BCryptDecrypt<br />
&emsp; VaultOpenVault<br />
&emsp; VaultCloseVault<br />
&emsp; VaultEnumerateItems<br />
&emsp; VaultGetItemWin8<br />
&emsp; VaultGetItemWin7<br />
&emsp; VaultFree<br />
&emsp; StrCmpCA<br />
&emsp; StrStrA<br />
&emsp; PathMatchSpecA<br />
&emsp; SHGetFolderPathA<br />
&emsp; ShellExecuteExA<br />
&emsp; GdipGetImageEncodersSize<br />
&emsp; GdipGetImageEncoders<br />
&emsp; GdipCreateBitmapFromHBITMAP<br />
&emsp; GdiplusStartup<br />
&emsp; GdiplusShutdown<br />
&emsp; GdipSaveImageToStream<br />
&emsp; GdipDisposeImage<br />
&emsp; GdipFree<br />
&emsp; CreateStreamOnHGlobal<br />
&emsp; GetHGlobalFromStream<br />
&emsp; SymMatchString<br />
&emsp; HEAD<br />
&emsp; HTTP/1.1<br />
&emsp; GET<br />
&emsp; POST<br />
&emsp; file<br />
&emsp; Content-Type: multipart/form-data; boundary=----<br />
&emsp; Content-Disposition: form-data; name="<br />
&emsp; Content-Disposition: form-data; name="file"; filename="<br />
&emsp; Content-Type: application/octet-stream<br />
&emsp; Content-Transfer-Encoding: binary<br />
&emsp; SOFT: <br />
&emsp; PROF: ?<br />
&emsp; PROF: <br />
&emsp; HOST: <br />
&emsp; USER: <br />
&emsp; PASS: <br />
&emsp; sqlite3_open<br />
&emsp; sqlite3_prepare_v2<br />
&emsp; sqlite3_step<br />
&emsp; sqlite3_column_text<br />
&emsp; sqlite3_finalize<br />
&emsp; sqlite3_close<br />
&emsp; sqlite3_column_bytes<br />
&emsp; sqlite3_column_blob<br />
&emsp; encrypted_key<br />
&emsp; "}<br />
&emsp; PATH<br />
&emsp; PATH=<br />
&emsp; NSS_Init<br />
&emsp; NSS_Shutdown<br />
&emsp; PK11_GetInternalKeySlot<br />
&emsp; PK11_FreeSlot<br />
&emsp; PK11_Authenticate<br />
&emsp; PK11SDR_Decrypt<br />
&emsp; SELECT origin_url, username_value, password_value FROM logins<br />
&emsp; Cookies\%s_%s.txt<br />
&emsp; SELECT HOST_KEY , is_httponly , path , is_secure , (expires_utc/1000000)-11644480800 , name , encrypted_value from cookies<br />
&emsp; TRUE<br />
&emsp; FALSE<br />
&emsp; Autofill\%s_%s.txt<br />
&emsp; SELECT name, value FROM autofill<br />
&emsp; CC\%s_%s.txt<br />
&emsp; SELECT name_on_card, expiration_month, expiration_year, card_number_encrypted FROM credit_cards<br />
&emsp; Card number: <br />
&emsp; 
Name on card: <br />
&emsp; 
Expiration date: <br />
&emsp; History\%s_%s.txt<br />
&emsp; SELECT url FROM urls<br />
&emsp; Downloads\%s_%s.txt<br />
&emsp; SELECT target_path, tab_url from downloads<br />
&emsp; Login Data<br />
&emsp; Cookies<br />
&emsp; Web Data<br />
&emsp; History<br />
&emsp; SELECT host, isHttpOnly, path, isSecure, expiry, name, value FROM moz_cookies<br />
&emsp; logins.json<br />
&emsp; formSubmitURL<br />
&emsp; usernameField<br />
&emsp; encryptedUsername<br />
&emsp; encryptedPassword<br />
&emsp; guid<br />
&emsp; SELECT fieldname, value FROM moz_formhistory<br />
&emsp; SELECT url FROM moz_places<br />
&emsp; cookies.sqlite<br />
&emsp; formhistory.sqlite<br />
&emsp; places.sqlite<br />
&emsp; \Local State<br />
&emsp; ..\profiles.ini<br />
&emsp; C:\ProgramData\<br />
&emsp; Chrome<br />
&emsp; \Google\Chrome\User Data<br />
&emsp; ChromeBeta<br />
&emsp; \Google\Chrome Beta\User Data<br />
&emsp; ChromeCanary<br />
&emsp; \Google\Chrome SxS\User Data<br />
&emsp; Chromium<br />
&emsp; \Chromium\User Data<br />
&emsp; Edge_Chromium<br />
&emsp; \Microsoft\Edge\User Data<br />
&emsp; Kometa<br />
&emsp; \Kometa\User Data<br />
&emsp; Amigo<br />
&emsp; \Amigo\User Data<br />
&emsp; Torch<br />
&emsp; \Torch\User Data<br />
&emsp; Orbitum<br />
&emsp; \Orbitum\User Data<br />
&emsp; Comodo<br />
&emsp; \Comodo\Dragon\User Data<br />
&emsp; Nichrome<br />
&emsp; \Nichrome\User Data<br />
&emsp; Maxthon5<br />
&emsp; \Maxthon5\Users<br />
&emsp; Sputnik<br />
&emsp; \Sputnik\User Data<br />
&emsp; EPB<br />
&emsp; \Epic Privacy Browser\User Data<br />
&emsp; Vivaldi<br />
&emsp; \Vivaldi\User Data<br />
&emsp; CocCoc<br />
&emsp; \CocCoc\Browser\User Data<br />
&emsp; Uran<br />
&emsp; \uCozMedia\Uran\User Data<br />
&emsp; QIP<br />
&emsp; \QIP Surf\User Data<br />
&emsp; Cent<br />
&emsp; \CentBrowser\User Data<br />
&emsp; Elements<br />
&emsp; \Elements Browser\User Data<br />
&emsp; TorBro<br />
&emsp; \TorBro\Profile<br />
&emsp; CryptoTab<br />
&emsp; \CryptoTab Browser\User Data<br />
&emsp; Brave<br />
&emsp; \BraveSoftware\Brave-Browser\User Data<br />
&emsp; Opera<br />
&emsp; \Opera Software\Opera Stable\<br />
&emsp; OperaGX<br />
&emsp; \Opera Software\Opera GX Stable\<br />
&emsp; OperaNeon<br />
&emsp; \Opera Software\Opera Neon\User Data<br />
&emsp; Firefox<br />
&emsp; \Mozilla\Firefox\Profiles\<br />
&emsp; SlimBrowser<br />
&emsp; \FlashPeak\SlimBrowser\Profiles\<br />
&emsp; PaleMoon<br />
&emsp; \Moonchild Productions\Pale Moon\Profiles\<br />
&emsp; Waterfox<br />
&emsp; \Waterfox\Profiles\<br />
&emsp; Cyberfox<br />
&emsp; \8pecxstudios\Cyberfox\Profiles\<br />
&emsp; BlackHawk<br />
&emsp; \NETGATE Technologies\BlackHawk\Profiles\<br />
&emsp; IceCat<br />
&emsp; \Mozilla\icecat\Profiles\<br />
&emsp; KMeleon<br />
&emsp; \K-Meleon\<br />
&emsp; Thunderbird<br />
&emsp; \Thunderbird\Profiles\<br />
&emsp; passwords.txt<br />
&emsp; ibnejdfjmmkpcnlpebklmnkoeoihofec<br />
&emsp; TronLink<br />
&emsp; nkbihfbeogaeaoehlefnkodbefgpgknn<br />
&emsp; MetaMask<br />
&emsp; fhbohimaelbohpjbbldcngcnapndodjp<br />
&emsp; Binance Chain Wallet<br />
&emsp; ffnbelfdoeiohenkjibnmadjiehjhajb<br />
&emsp; Yoroi<br />
&emsp; jbdaocneiiinmjbjlgalhcelgbejmnid<br />
&emsp; Nifty Wallet<br />
&emsp; afbcbjpbpfadlkmhmclhkeeodmamcflc<br />
&emsp; Math Wallet<br />
&emsp; hnfanknocfeofbddgcijnmhnfnkdnaad<br />
&emsp; Coinbase Wallet<br />
&emsp; hpglfhgfnhbgpjdenjgmdgoeiappafln<br />
&emsp; Guarda<br />
&emsp; blnieiiffboillknjnepogjhkgnoapac<br />
&emsp; EQUAL Wallet<br />
&emsp; cjelfplplebdjjenllpjcblmjkfcffne<br />
&emsp; Jaxx Liberty<br />
&emsp; fihkakfobkmkjojpchpfgcmhfjnmnfpi<br />
&emsp; BitApp Wallet<br />
&emsp; kncchdigobghenbbaddojjnnaogfppfj<br />
&emsp; iWallet<br />
&emsp; amkmjjmmflddogmhpjloimipbofnfjih<br />
&emsp; Wombat<br />
&emsp; nlbmnnijcnlegkjjpcfjclmcfggfefdm<br />
&emsp; MEW CX<br />
&emsp; nanjmdknhkinifnkgdcggcfnhdaammmj<br />
&emsp; GuildWallet<br />
&emsp; nkddgncdjgjfcddamfgcmfnlhccnimig<br />
&emsp; Saturn Wallet<br />
&emsp; fnjhmkhhmkbjkkabndcnnogagogbneec<br />
&emsp; Ronin Wallet<br />
&emsp; cphhlgmgameodnhkjdmkpanlelnlohao<br />
&emsp; NeoLine<br />
&emsp; nhnkbkgjikgcigadomkphalanndcapjk<br />
&emsp; Clover Wallet<br />
&emsp; kpfopkelmapcoipemfendmdcghnegimn<br />
&emsp; Liquality Wallet<br />
&emsp; aiifbnbfobpmeekipheeijimdpnlpgpp<br />
&emsp; Terra Station<br />
&emsp; dmkamcknogkgcdfhhbddcghachkejeap<br />
&emsp; Keplr<br />
&emsp; fhmfendgdocmcbmfikdcogofphimnkno<br />
&emsp; Sollet<br />
&emsp; cnmamaachppnkjgnildpdmkaakejnhae<br />
&emsp; Auro Wallet<br />
&emsp; jojhfeoedkpkglbfimdfabpdfjaoolaf<br />
&emsp; Polymesh Wallet<br />
&emsp; flpiciilemghbmfalicajoolhkkenfel<br />
&emsp; ICONex<br />
&emsp; nknhiehlklippafakaeklbeglecifhad<br />
&emsp; Nabox Wallet<br />
&emsp; hcflpincpppdclinealmandijcmnkbgn<br />
&emsp; KHC<br />
&emsp; ookjlbkiijinhpmnjffcofjonbfbgaoc<br />
&emsp; Temple<br />
&emsp; mnfifefkajgofkcjkemidiaecocnkjeh<br />
&emsp; TezBox<br />
&emsp; dkdedlpgdmmkkfjabffeganieamfklkm<br />
&emsp; Cyano Wallet<br />
&emsp; nlgbhdfgdhgbiamfdfmbikcdghidoadd<br />
&emsp; Byone<br />
&emsp; infeboajgfhgbjpjbeppbkgnabfdkdaf<br />
&emsp; OneKey<br />
&emsp; cihmoadaighcejopammfbmddcmdekcje<br />
&emsp; LeafWallet<br />
&emsp; lodccjjbdhfakaekdiahmedfbieldgik<br />
&emsp; DAppPlay<br />
&emsp; ijmpgkjfkbfhoebgogflfebnmejmfbml<br />
&emsp; BitClip<br />
&emsp; lkcjlnjfpbikmcmbachjpdbijejflpcm<br />
&emsp; Steem Keychain<br />
&emsp; onofpnbbkehpmmoabgpcpmigafmmnjhl<br />
&emsp; Nash Extension<br />
&emsp; bcopgchhojmggmffilplmbdicgaihlkp<br />
&emsp; Hycon Lite Client<br />
&emsp; klnaejjgbibmhlephnhpmaofohgkpgkd<br />
&emsp; ZilPay<br />
&emsp; aeachknmefphepccionboohckonoeemg<br />
&emsp; Coin98 Wallet<br />
&emsp; bfnaelmomeimhlpmgjnjophhpkkoljpa<br />
&emsp; Phantom<br />
&emsp; hifafgmccdpekplomjjkcfgodnhcellj<br />
&emsp; Crypto.com<br />
&emsp; dngmlblcodfobpdpecaadgfbcggfjfnm<br />
&emsp; Maiar DeFi Wallet<br />
&emsp; ppdadbejkmjnefldpcdjhnkpbjkikoip<br />
&emsp; Oasis<br />
&emsp; hpbgcgmiemanfelegbndmhieiigkackl<br />
&emsp; MonstaWallet<br />
&emsp; fcckkdbjnoikooededlapcalpionmalo<br />
&emsp; MOBOX<br />
&emsp; jccapkebeeiajkkdemacblkjhhhboiek<br />
&emsp; Crust Wallet<br />
&emsp; mgffkfbidihjpoaomajlbgchddlicgpn<br />
&emsp; Pali Wallet<br />
&emsp; nphplpgoakhhjchkkhmiggakijnkhfnd<br />
&emsp; TON Wallet<br />
&emsp; ldinpeekobnhjjdofggfgjlcehhmanlj<br />
&emsp; Hiro Wallet<br />
&emsp; pocmplpaccanhmnllbbkpgfliimjljgo<br />
&emsp; Slope Wallet<br />
&emsp; bhhhlbepdkbapadjdnnojkbgioiodbic<br />
&emsp; Solflare Wallet<br />
&emsp; pgiaagfkgcbnmiiolekcfmljdagdhlcm<br />
&emsp; Stargazer Wallet<br />
&emsp; cgeeodpfagjceefieflmdfphplkenlfk<br />
&emsp; EVER Wallet<br />
&emsp; gjkdbeaiifkpoencioahhcilildpjhgh<br />
&emsp; partisia-wallet<br />
&emsp; bgjogpoidejdemgoochpnkmdjpocgkha<br />
&emsp; Ecto Wallet<br />
&emsp; ifckdpamphokdglkkdomedpdegcjhjdp<br />
&emsp; ONTO Wallet<br />
&emsp; agechnindjilpccclelhlbjphbgnobpf<br />
&emsp; Fractal Wallet<br />
&emsp; algblmhagnobbnmakepomicmfljlbehg<br />
&emsp; ADS Wallet<br />
&emsp; imijjbmbnebfnbmonjeileijahaipglj<br />
&emsp; Moonlet Wallet<br />
&emsp; kpjdchaapjheajadlaakiiigcbhoppda<br />
&emsp; ZEBEDEE<br />
&emsp; dlcobpjiigpikoobohmabehhmhfoodbb<br />
&emsp; Argent X StarkNet Wallet<br />
&emsp; bofddndhbegljegmpmnlbhcejofmjgbn<br />
&emsp; X-Wallet<br />
&emsp; mapbhaebnddapnmifbbkgeedkeplgjmf<br />
&emsp; Biport Wallet<br />
&emsp; kfdniefadaanbjodldohaedphafoffoh<br />
&emsp; Typhon Wallet<br />
&emsp; jaooiolkmfcmloonphpiiogkfckgciom<br />
&emsp; Twetch Wallet<br />
&emsp; aijcbedoijmgnlmjeegjaglmepbmpkpi<br />
&emsp; Leap Wallet<br />
&emsp; fhfffofbcgbjjojdnpcfompojdjjhdim<br />
&emsp; Lamden Wallet<br />
&emsp; agkfnefiabmfpanochlcakggnkdfmmjd<br />
&emsp; Earth Wallet<br />
&emsp; lpfcbjknijpeeillifnkikgncikgfhdo<br />
&emsp; Nami<br />
&emsp; fecfflganphcinpahcklgahckeohalog<br />
&emsp; Coin Wallet<br />
&emsp; ilhaljfiglknggcoegeknjghdgampffk<br />
&emsp; Beam Web Wallet<br />
&emsp; dklmlehijiaepdijfnbbhncfpcoeeljf<br />
&emsp; FShares Wallet<br />
&emsp; fkhebcilafocjhnlcngogekljmllgdhd<br />
&emsp; WAGMIswap.io Wallet<br />
&emsp; laphpbhjhhgigmjoflgcchgodbbclahk<br />
&emsp; BLUE - Worlds Safest and Simplest Wallet<br />
&emsp; mkjjflkhdddfjhonakofipfojoepfndk<br />
&emsp; Unification Web Wallet<br />
&emsp; jnldfbidonfeldmalbflbmlebbipcnle<br />
&emsp; Infinity Wallet<br />
&emsp; ellkdbaphhldpeajbepobaecooaoafpg<br />
&emsp; Fetch.ai Network Wallet<br />
&emsp; iokeahhehimjnekafflcihljlcjccdbe<br />
&emsp; Alby Wallet<br />
&emsp; omajpeaffjgmlpmhbfdjepdejoemifpe<br />
&emsp; xBull Wallet<br />
&emsp; pgojdfajgcjjpjnbpfaelnpnjocakldb<br />
&emsp; Sugarchain Wallet<br />
&emsp; pnndplcbkakcplkjnolgbkdgjikjednm<br />
&emsp; Tronium<br />
&emsp; fnnegphlobjdpkhecapkijjdkgcjhkib<br />
&emsp; Harmony<br />
&emsp; fhilaheimglignddkjgofkcbgekhenbh<br />
&emsp; Oxygen<br />
&emsp; cmbagcoinhmacpcgmbiniijboejgiahi<br />
&emsp; JustLiquidity Wallet<br />
&emsp; kmmolakhbgdlpkjkcjkebenjheonagdm<br />
&emsp; AlgoSigner<br />
&emsp; fnabdmcgpkkjjegokfcnfbpneacddpfh<br />
&emsp; Goldmint Lite Wallet<br />
&emsp; bgpipimickeadkjlklgciifhnalhdjhe<br />
&emsp; GeroWallet<br />
&emsp; hoighigmnhgkkdaenafgnefkcmipfjon<br />
&emsp; EO.Finance<br />
&emsp; nlgnepoeokdfodgjkjiblkadkjbdfmgd<br />
&emsp; Multi Wallet<br />
&emsp; nhihjlnjgibefgjhobhcphmnckoogdea<br />
&emsp; Waves Enterprise Wallet<br />
&emsp; ehibhohmlpipbaogcknmpmiibbllplph<br />
&emsp; Bluehelix Wallet<br />
&emsp; magbanejlegnbcppjljfhnmfmghialkl<br />
&emsp; Nebulas Wallet<br />
&emsp; fgkaeeikaoeiiggggbgdcjchmdfmamla<br />
&emsp; Vtimes<br />
&emsp; pnlfjmlcjdjgkddecgincndfgegkecke<br />
&emsp; Crocobit Wallet<br />
&emsp; bhghoamapcdpbohphigoooaddinpkbai<br />
&emsp; Authenticator<br />
&emsp; gaedmjdfmmahhbjefcbgaolhhanlaolb<br />
&emsp; Authy<br />
&emsp; oeljdldpnmdbchonielidgobddffflal<br />
&emsp; EOS Authenticator<br />
&emsp; ilgcnhelpchnceeipipijaljkblbcobl<br />
&emsp; GAuth Authenticator<br />
&emsp; imloifkgjagghnncjkhggdhalmcnfklk<br />
&emsp; Trezor Password Manager<br />
&emsp; %s\%s\Local Extension Settings\%s<br />
&emsp; %s\CURRENT<br />
&emsp; %s\%s\Sync Extension Settings\%s<br />
&emsp; %s\%s\IndexedDB\chrome-extension_%s_0.indexeddb.leveldb<br />
&emsp; Plugins\<br />
&emsp; HARDWARE\DESCRIPTION\System\CentralProcessor\0<br />
&emsp; ProcessorNameString<br />
&emsp; SOFTWARE\Microsoft\Windows NT\CurrentVersion<br />
&emsp; ProductName<br />
&emsp; x64<br />
&emsp; x86<br />
&emsp; DISPLAY<br />
&emsp; SOFTWARE\Microsoft\Cryptography<br />
&emsp; MachineGuid<br />
&emsp; SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall<br />
&emsp; DisplayName<br />
&emsp; DisplayVersion<br />
&emsp; screenshot.jpg<br />
&emsp; ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890<br />
&emsp; /c timeout /t 5 &amp; del /f /q "%s" &amp; exit<br />
&emsp; C:\Windows\System32\cmd.exe<br />
</details>
<p><br /></p>

<h1 id="dynamic-linking">Dynamic linking</h1>

<p>The adress of <code class="language-plaintext highlighter-rouge">GetProcAddress()</code> and <code class="language-plaintext highlighter-rouge">LoadLibraryA()</code>  is retrieved by the same method in Dynamic_Linking_1  looping over the exported functions of the kernel32.DLL , then it uses  <code class="language-plaintext highlighter-rouge">LoadLibraryA()</code> to Load the specified module into the address space and get a handle that get passed to  <code class="language-plaintext highlighter-rouge">GetProcAddress()</code> to retrieve the address of an exported function from the specified dynamic-link library.<br />
Dynamic_Linking_2 is loading the APIs only needed to do some checks if it passes it will load others needed for stealing functionality.</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/11.png" /> 
</p>

<p>dword_42774 is <code class="language-plaintext highlighter-rouge">GetProcAddress()</code> it is called in other function which is Dynamic_Linking_3 that will load other APIs needed for stealing functionality.</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/12.png" /> 
</p>

<p>We use idapython to rename the global variables with the api name to make reversing easier</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/13.png" /> 
</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">idc</span>

<span class="n">start_Addrs</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x00415F86</span><span class="p">,</span><span class="mh">0x00415FC0</span> <span class="p">,</span><span class="mh">0x004161A0</span> <span class="p">]</span>
<span class="n">end_Addrs</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x00415FB7</span><span class="p">,</span><span class="mh">0x00416176</span><span class="p">,</span><span class="mh">0x00417034</span><span class="p">]</span>

<span class="n">string_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start_Addrs</span><span class="p">)):</span>
    <span class="n">ea</span> <span class="o">=</span> <span class="n">start_Addrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">end_Addrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">while</span> <span class="n">ea</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">==</span> <span class="s">"push"</span>  <span class="p">)</span><span class="ow">and</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">o_imm</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_strlit_contents</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)).</span><span class="n">decode</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">==</span> <span class="s">"mov"</span>  <span class="ow">and</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">o_reg</span><span class="p">)</span><span class="ow">and</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">o_mem</span><span class="p">))</span> <span class="p">:</span>
            <span class="n">temp_name</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="s">"Str_"</span> <span class="o">==</span> <span class="n">temp_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">temp_name</span><span class="p">[</span><span class="mi">4</span><span class="p">::]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">==</span> <span class="s">"mov"</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">o_mem</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">o_reg</span><span class="p">):</span>
            <span class="n">global_var</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">idc</span><span class="p">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">global_var</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">SN_NOWARN</span><span class="p">)</span>

        <span class="n">ea</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">next_head</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="anti-sandbox">Anti-Sandbox</h1>

<p>Since a lot of sandboxes hook and bypass <code class="language-plaintext highlighter-rouge">Sleep()</code> preventing malware being idle over their execution time.
The malware first calls   <code class="language-plaintext highlighter-rouge">GetTickCount()</code> function that retrieves the number of milliseconds that have elapsed since the system was started, up to 49.7 days, that is our first timestamp. Then calls the <code class="language-plaintext highlighter-rouge">Sleep()</code> to suspend itself for 16 seconds. calling <code class="language-plaintext highlighter-rouge">GetTickCount()</code> again gets our second timestamp . The malware checks if at least 12 seconds diffrence between the 2 timestampes . If the function returns flase it means that the <code class="language-plaintext highlighter-rouge">Sleep()</code> hasn’t been skipped the malware assumes that it is running in a sandbox and exits immediately.</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/15.png" /> 
</p>

<h1 id="anti-cis">Anti-CIS</h1>

<p>This is one of the easy tricks to check if the malware is not infected users from specific countries.</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/16.png" /> 
</p>

<p>Mars checks the user language to determine if it’s part of the Commonwealth of Independent States (CIS) countrie it gets the user language ID by using GetUserDefaultLangID and it compares the user language ID to:</p>

<table>
  <thead>
    <tr>
      <th>Language ID</th>
      <th>Country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x43F</td>
      <td>Kazakhstan</td>
    </tr>
    <tr>
      <td>0x443</td>
      <td>Uzbekistan</td>
    </tr>
    <tr>
      <td>0x82C</td>
      <td>Azerbaijan</td>
    </tr>
    <tr>
      <td>0x43Fu</td>
      <td>Kazakhstan</td>
    </tr>
    <tr>
      <td>0x419u</td>
      <td>Russia</td>
    </tr>
    <tr>
      <td>0x423u</td>
      <td>Belarus</td>
    </tr>
  </tbody>
</table>

<p>If the user language ID matches one of the IDs above, it will exit.</p>

<h1 id="anti-emulation">Anti-Emulation</h1>

<p>If the malware is executed with the computer name <code class="language-plaintext highlighter-rouge">HAL9TH</code>  and the username with <code class="language-plaintext highlighter-rouge">JohnDoe</code>  it will exit . This check is done because it is the name given to the Windows Defender Emulator, this technique is used by malware to prevent itself from running in an emulated environment.</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/17.png" /> 
</p>

<h1 id="mutex">Mutex</h1>

<p>The malware creates a mutex object using <code class="language-plaintext highlighter-rouge">CreateMutexA()</code> to avoid having more than one instance running.  Then calls<code class="language-plaintext highlighter-rouge"> GetLastError() </code>which gets the last error, and if the error code is equal to 183 (ERROR_ALREADY_EXIST) it means that mutex already exists and an instance of the malware is already running therefore malware exits.</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/18.png" /> 
</p>

<h1 id="anti-debug">Anti-Debug</h1>

<p>The malware create thread that checks <code class="language-plaintext highlighter-rouge">BeingDebugged</code> flag which is Special flag in system tables, which dwell in process memory and which an operation system sets, can be used to indicate that the process is being debugged. The states of these flags can be verified either by using specific API functions or examining the system tables in memory. 
If the malware is being debugged it exits . 
The thread is going to keep running until the malware finishes excution or the thread end the malware excution if its being debugged .</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/19.png" /> 
</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/20.png" /> 
</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/21.png" /> 
</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/22.png" /> 
</p>

<h1 id="expiration-check">Expiration check</h1>

<p>The Expiration date variable contains the date 26/04/2022 20:00:00.</p>

<p>Mars uses <a href="https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemtime">GetSystemTime()</a> to get current system date and time as <a href="https://docs.microsoft.com/en-us/windows/win32/api/minwinbase/ns-minwinbase-systemtime">SYSTEMTIME</a> structe, then calls <code class="language-plaintext highlighter-rouge">sscanf()</code> to parse the Expiration date to a SYSTEMTIME structe . <a href="https://docs.microsoft.com/en-us/windows/win32/api/timezoneapi/nf-timezoneapi-systemtimetofiletime">SystemTimeToFileTime()</a> take SYSTEMTIME structe as argument then convert it to file time and Expiration date although is converted to file time.</p>

<p>If the current time exceedes the Expiration time, the malware calls <code class="language-plaintext highlighter-rouge">ExitProcess()</code> to exit immediately.</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/24.png" /> 
</p>

<h1 id="main-functionality">Main Functionality</h1>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/malware-analysis/Mars/53.png"><img src="/assets/malware-analysis/Mars/53.png" alt="0" /></a></td>
      <td><a href="/assets/malware-analysis/Mars/49.png"><img src="/assets/malware-analysis/Mars/49.png" alt="0" /></a></td>
    </tr>
  </tbody>
</table>

<p>Mars generate random string that will be the name of the zip file contains stolen data.</p>

<p>The communications between c2 and the malware is described as:</p>
<ol>
  <li>sends a GET request to the C2 URL on the <code class="language-plaintext highlighter-rouge">/RyC66VfSGP.php</code> endpoint to grab its configuration .</li>
  <li>fetches all DLLs on the <code class="language-plaintext highlighter-rouge">/request</code> endpoint, the libraries are zipped</li>
  <li>Stolen data are posted to the C2 on the same URL used in step 1.</li>
</ol>

<p>Dlls retrieved:</p>

<table>
  <thead>
    <tr>
      <th>DLL Name</th>
      <th>Description</th>
      <th>Save path</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>sqlite3.dll</td>
      <td>Enables SQLite related operations</td>
      <td>none (mars doesnt write it on disk, parsed from memory)</td>
    </tr>
    <tr>
      <td>freebl3.dll</td>
      <td>Library for the NSS (Gecko-based browsers)</td>
      <td>C:\ProgramData\freebl3.dll</td>
    </tr>
    <tr>
      <td>mozglue.dll</td>
      <td>Mozilla Browser Library</td>
      <td>C:\ProgramData\mozglue.dll</td>
    </tr>
    <tr>
      <td>msvcp140.dll</td>
      <td>Visual C++ Runtime 2015</td>
      <td>C:\ProgramData\msvcp140.dll</td>
    </tr>
    <tr>
      <td>nss3.dll</td>
      <td>Network System Services Library (Gecko-based browsers)</td>
      <td>C:\ProgramData\nss3.dll</td>
    </tr>
    <tr>
      <td>softokn3.dll</td>
      <td>Mozilla Browser Library</td>
      <td>C:\ProgramData\softokn3.dll</td>
    </tr>
    <tr>
      <td>vcruntime140.dll</td>
      <td>Visual C++ Runtime 2015</td>
      <td>C:\ProgramData\vcruntime140.dll</td>
    </tr>
  </tbody>
</table>

<p>Another diffrence from the last version is that sqlite3 isnt written on disk, it just get parsed and passed to another function to get handle to it and start loading needed function , the other dll are written .</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/52.png" /> 
</p>
<p>Since the C2 was down i got the pcap from <a href="https://tria.ge/220406-k1kttacaf2">Hatching sandbox</a>.</p>
<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/26.png" /> 
</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/27.png" /> 
</p>

<h2 id="understanding-configuration-format">Understanding Configuration Format</h2>
<p>configuration is base64 encoded</p>

<p><code class="language-plaintext highlighter-rouge">MXwxfDF8MXwxfDVxRGxQdVZLb1J8RGlzY29yZHwwfCVBUFBEQVRBJVxkaXNjb3JkXExvY2FsIFN0b3JhZ2VcfCp8MXwwfDB8VGVsZWdyYW1
8MHwlQVBQREFUQSVcVGVsZWdyYW0gRGVza3RvcFx0ZGF0YVx8KkQ4NzdGNzgzRDVEM0VGOEMqLCptYXAqLCpjb25maWdzKnwxfDB8MHw=</code></p>

<p><code class="language-plaintext highlighter-rouge">1|1|1|1|1|5qDlPuVKoR|Discord|0|%APPDATA%\discord\Local Storage\ |*|1|0|0|Telegram|0|%APPDATA%\Telegram Desktop\tdata\ |*D877F783D5D3EF8C*,*map*,*configs*|1|0|0|</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">base64</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64decode</span><span class="p">(</span><span class="s">"MXwxfDF8MXwxfDVxRGxQdVZLb1J8RGlzY29yZHwwfCVBUFBEQVRBJVxkaXNjb3JkXExvY2FsIFN0b3JhZ2VcfCp8MXwwfDB8VGVsZWdyYW18MHwlQVBQREFUQSVcVGVsZWdyYW0gRGVza3RvcFx0ZGF0YVx8KkQ4NzdGNzgzRDVEM0VGOEMqLCptYXAqLCpjb25maWdzKnwxfDB8MHw="</span><span class="p">).</span><span class="n">decode</span><span class="p">()</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"|"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"First Part : </span><span class="se">\n</span><span class="s">"</span> <span class="p">,</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Second Part :"</span> <span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">),</span><span class="mi">7</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">7</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>First Part : 
 ['1', '1', '1', '1', '1', '5qDlPuVKoR']
Second Part :
['Discord', '0', '%APPDATA%\\discord\\Local Storage\\', '*', '1', '0', '0']
['Telegram', '0', '%APPDATA%\\Telegram Desktop\tdata\\', '*D877F783D5D3EF8C*,*map*,*configs*', '1', '0', '0']
</code></pre></div></div>

<ul>
  <li>First part</li>
</ul>

<table>
  <thead>
    <tr>
      <th>Config</th>
      <th>Meaning</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>Downloads_history_Flag</td>
    </tr>
    <tr>
      <td>1</td>
      <td>Browser_History_Flag</td>
    </tr>
    <tr>
      <td>1</td>
      <td>Autofill_Flag</td>
    </tr>
    <tr>
      <td>1</td>
      <td>ScreenShoot_Flag</td>
    </tr>
    <tr>
      <td>1</td>
      <td>Self_Deletion_Flag</td>
    </tr>
    <tr>
      <td>5qDlPuVKoR</td>
      <td>Explorer Credentials FileName</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>Second part</li>
</ul>

<table>
  <thead>
    <tr>
      <th>Config</th>
      <th>Meaning</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Discord</td>
      <td>name for the zip file – will contain all the stolen files that related to the current task.so the name for the zip will be name.zip.</td>
    </tr>
    <tr>
      <td>0</td>
      <td>maybe max size (no indecation of use)</td>
    </tr>
    <tr>
      <td>%APPDATA%\discord\Local Storage\</td>
      <td>An environment variable name and folder name – a starting point for the recursive Grabber.</td>
    </tr>
    <tr>
      <td>*</td>
      <td>A regex list – contains multiply parameters that are separated by “,” each one of them is a regex that represents a file type.</td>
    </tr>
    <tr>
      <td>1</td>
      <td>is_Recursive</td>
    </tr>
    <tr>
      <td>0</td>
      <td>Write to zip enabled if 0</td>
    </tr>
    <tr>
      <td>0</td>
      <td>Exclusion List</td>
    </tr>
  </tbody>
</table>

<h2 id="grabber">Grabber</h2>

<p>lets dig into <code class="language-plaintext highlighter-rouge">Config_Grabber</code> function to see how you it works</p>

<p>after receiving the config we can see the it has a lot of <code class="language-plaintext highlighter-rouge">|</code> so it split the config with <code class="language-plaintext highlighter-rouge">|</code> delimiter and loop through the splited config.
the first part enables/disable some of the stealer functionality then it starts in part 2 which start grapping files wanted.</p>

<p>as example</p>
<blockquote>
  <p>[‘Discord’, ‘0’, ‘%APPDATA%\discord\Local Storage\’, ‘*’, ‘1’, ‘0’, ‘0’]</p>
</blockquote>

<p>it start recurseively grabbing all files in <code class="language-plaintext highlighter-rouge">discord\\Local Storage\\</code>  under <code class="language-plaintext highlighter-rouge">%APPDATA%</code> and put them in discord.zip</p>

<table>
  <tbody>
    <tr>
      <td><a href="/assets/malware-analysis/Mars/30.png"><img src="/assets/malware-analysis/Mars/30.png" alt="0" /></a></td>
      <td><a href="/assets/malware-analysis/Mars/31.png"><img src="/assets/malware-analysis/Mars/31.png" alt="0" /></a></td>
    </tr>
    <tr>
      <td><a href="/assets/malware-analysis/Mars/32.png"><img src="/assets/malware-analysis/Mars/32.png" alt="0" /></a></td>
      <td><a href="/assets/malware-analysis/Mars/33.png"><img src="/assets/malware-analysis/Mars/33.png" alt="0" /></a></td>
    </tr>
  </tbody>
</table>

<p>If there is more than one regex as in</p>
<blockquote>
  <p>[‘Telegram’, ‘0’, ‘%APPDATA%\Telegram Desktop\tdata\’, ‘<em>D877F783D5D3EF8C</em>,<em>map</em>,<em>configs</em>’, ‘1’, ‘0’, ‘0’]</p>
</blockquote>

<p>it loops through them and call <code class="language-plaintext highlighter-rouge">Recursive_Grabber</code> with each regex .</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/34.png" /> 
</p>

<h2 id="browsers">Browsers</h2>
<p>Mars steals credentials from browsers by static paths. It has four different methods to steal data from different types of browses, like Gecko-based browsers, Opera, Internet Explorer and Chromium-based browsers.</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/43.png" /> 
</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/44.png" /> 
</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/45.png" /> 
</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/46.png" /> 
</p>

<h3 id="data-extraction">Data Extraction</h3>

<p>All the extraction functions have the same scheme:</p>
<ol>
  <li>The malware saves the addresses of the functions from sqlite3.dll
    <ul>
      <li>sqlite3_open</li>
      <li>sqlite3_prepare_v2</li>
      <li>sqlite3_step</li>
      <li>sqlite3_column_bytes</li>
      <li>sqlite3_column_blob</li>
      <li>sqlite3_column_text</li>
      <li>sqlite3_column_finalize</li>
      <li>sqlite3_column_close</li>
    </ul>
  </li>
  <li>It generates a random string (length of 8 characters) and copies the DB file to a temp folder named like the random
string – all the extractions methods will be on the copied DB.
In order to extract the data from the DB, the malware has to create the SQL query and query the DB using sqlite3.dll functions.</li>
  <li>The malware opens the DB by using sqlite3_open and passes the DB path.</li>
  <li>It calls to sqlite3_prepare_v2, the function gets a handle to DB and the SQL query and returns a statement handle.</li>
  <li>By using sqlite3_column_bytes/sqlite3_column_blob/sqlite3_column_text, the malware can get the results from the queries</li>
  <li>The Credentials in Chromium-based browsers DB are encrypted by DPAPI and, therefore, the malware uses the function CryptUnprotectData to decrypt the Credentials.</li>
</ol>

<p>Mars steals information from the Windows Vault, which is the default storage vault for the credential manager information. This is done through the use of Vaultcli.dll, which encapsulates the necessary functions to access the Vault. The malware loops through its items using:</p>

<ul>
  <li>VaultEnumerateVaults</li>
  <li>VaultOpenVault</li>
  <li>VaultEnumerateItems</li>
  <li>VaultGetItem</li>
  <li>VaultFree</li>
</ul>

<h3 id="targeted-db-files">Targeted DB Files</h3>

<table>
  <thead>
    <tr>
      <th>File Name</th>
      <th>Affected Software</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>History</td>
      <td>Chromium-based browsers</td>
    </tr>
    <tr>
      <td>Login Data</td>
      <td>Chromium-based browsers</td>
    </tr>
    <tr>
      <td>Cookies</td>
      <td>Chromium-based browsers</td>
    </tr>
    <tr>
      <td>Web Data</td>
      <td>Chromium-based browsers</td>
    </tr>
    <tr>
      <td>formhistory.sqlite</td>
      <td>Gecko-based browsers</td>
    </tr>
    <tr>
      <td>cookies.sqlite</td>
      <td>Gecko-based browsers</td>
    </tr>
    <tr>
      <td>signongs.sqlite</td>
      <td>Gecko-based browsers</td>
    </tr>
    <tr>
      <td>places.sqlite</td>
      <td>Gecko-based browsers</td>
    </tr>
  </tbody>
</table>

<h3 id="queries-used">Queries Used</h3>

<table>
  <thead>
    <tr>
      <th>Query</th>
      <th>Target Browser</th>
      <th>Enabled</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>SELECT target_path, tab_url from downloads</td>
      <td>chromium , opera</td>
      <td>by default this feature is disabled,  enabled if Downloads_history_Flag is set to 1</td>
    </tr>
    <tr>
      <td>SELECT name, value FROM autofill</td>
      <td>chromium , opera</td>
      <td>by default this feature is disabled, enabled if Autofill_Flag is set to 1</td>
    </tr>
    <tr>
      <td>SELECT url FROM urls</td>
      <td>chromium , opera</td>
      <td>by default this feature is disabled,enabled if Browser_History_Flag is set to 1</td>
    </tr>
    <tr>
      <td>SELECT action_url, username_value, password_value FROM logins</td>
      <td>chromium , opera</td>
      <td>enabled by default</td>
    </tr>
    <tr>
      <td>SELECT HOST_KEY, is_httponly, path, is_secure, (expires_utc/1000000)-11644480800, name, encrypted_value from cookies</td>
      <td>chromium , opera</td>
      <td>enabled by default</td>
    </tr>
    <tr>
      <td>SELECT name_on_card, expiration_month, expiration_year, card_number_encrypted FROM credit_cards</td>
      <td>chromium , opera</td>
      <td>enabled by default</td>
    </tr>
    <tr>
      <td>SELECT host, isHttpOnly, path, isSecure, expiry, name, value FROM moz_cookies</td>
      <td>gecko</td>
      <td>enabled by default</td>
    </tr>
    <tr>
      <td>SELECT url FROM moz_places</td>
      <td>gecko</td>
      <td>by default this feature is disabled,enabled if Browser_History_Flag is set to 1</td>
    </tr>
    <tr>
      <td>SELECT fieldname, value FROM moz_formhistory</td>
      <td>gecko</td>
      <td>enabled by default</td>
    </tr>
  </tbody>
</table>

<h2 id="cryptocurrency-wallets-via-browser-extensions">Cryptocurrency Wallets via browser extensions</h2>

<p>Mars appears to also target additional Chrome-based browser extensions related to two-factor authentication (2FA) .</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/51.png" /> 
</p>

<p>Mars steal files from 3 folders :</p>

<ol>
  <li>\Local Extension Settings\Extension ID from Google Store</li>
  <li>\Sync Extension Settings\ Extension ID from Google Store</li>
  <li>\IndexedDB\Domain Name.indexeddb.leveldb</li>
</ol>

<p>as example if the victim uses Google Chrome with a crypto browser wallet extension, the extension files will be stored in:</p>

<p>C:\Users\Username\AppData\Local\Google\Chrome\User Data\Default\Local Extension Settings\Extension ID from Google Store
C:\Users\Username\AppData\Local\Google\Chrome\User Data\Default\Sync Extension Settings\ Extension ID from Google Store
C:\Users\Username\AppData\Local\Google\Chrome\User Data\Default\IndexedDB\Domain Name.indexeddb.leveldb</p>

<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Extension name</th>
      <th>Extension id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Crypto</td>
      <td>TronLink</td>
      <td>ibnejdfjmmkpcnlpebklmnkoeoihofec</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>MetaMask</td>
      <td>nkbihfbeogaeaoehlefnkodbefgpgknn</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Binance Chain Wallet</td>
      <td>fhbohimaelbohpjbbldcngcnapndodjp</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Yoroi</td>
      <td>ffnbelfdoeiohenkjibnmadjiehjhajb</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Nifty Wallet</td>
      <td>jbdaocneiiinmjbjlgalhcelgbejmnid</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Math Wallet</td>
      <td>afbcbjpbpfadlkmhmclhkeeodmamcflc</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Coinbase Wallet</td>
      <td>hnfanknocfeofbddgcijnmhnfnkdnaad</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Guarda</td>
      <td>hpglfhgfnhbgpjdenjgmdgoeiappafln</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>EQUAL Wallet</td>
      <td>blnieiiffboillknjnepogjhkgnoapac</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Jaxx Liberty</td>
      <td>cjelfplplebdjjenllpjcblmjkfcffne</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>BitApp Wallet</td>
      <td>fihkakfobkmkjojpchpfgcmhfjnmnfpi</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>iWallet</td>
      <td>kncchdigobghenbbaddojjnnaogfppfj</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Wombat</td>
      <td>amkmjjmmflddogmhpjloimipbofnfjih</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>MEW CX</td>
      <td>nlbmnnijcnlegkjjpcfjclmcfggfefdm</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>GuildWallet</td>
      <td>nanjmdknhkinifnkgdcggcfnhdaammmj</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Saturn Wallet</td>
      <td>nkddgncdjgjfcddamfgcmfnlhccnimig</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Ronin Wallet</td>
      <td>fnjhmkhhmkbjkkabndcnnogagogbneec</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>NeoLine</td>
      <td>cphhlgmgameodnhkjdmkpanlelnlohao</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Clover Wallet</td>
      <td>nhnkbkgjikgcigadomkphalanndcapjk</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Liquality Wallet</td>
      <td>kpfopkelmapcoipemfendmdcghnegimn</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Terra Station</td>
      <td>aiifbnbfobpmeekipheeijimdpnlpgpp</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Keplr</td>
      <td>dmkamcknogkgcdfhhbddcghachkejeap</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Sollet</td>
      <td>fhmfendgdocmcbmfikdcogofphimnkno</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Auro Wallet</td>
      <td>cnmamaachppnkjgnildpdmkaakejnhae</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Polymesh Wallet</td>
      <td>jojhfeoedkpkglbfimdfabpdfjaoolaf</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>ICONex</td>
      <td>flpiciilemghbmfalicajoolhkkenfel</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Nabox Wallet</td>
      <td>nknhiehlklippafakaeklbeglecifhad</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>KHC</td>
      <td>hcflpincpppdclinealmandijcmnkbgn</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Temple</td>
      <td>ookjlbkiijinhpmnjffcofjonbfbgaoc</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>TezBox</td>
      <td>mnfifefkajgofkcjkemidiaecocnkjeh</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Cyano Wallet</td>
      <td>dkdedlpgdmmkkfjabffeganieamfklkm</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Byone</td>
      <td>nlgbhdfgdhgbiamfdfmbikcdghidoadd</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>OneKey</td>
      <td>infeboajgfhgbjpjbeppbkgnabfdkdaf</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>LeafWallet</td>
      <td>cihmoadaighcejopammfbmddcmdekcje</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>DAppPlay</td>
      <td>lodccjjbdhfakaekdiahmedfbieldgik</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>BitClip</td>
      <td>ijmpgkjfkbfhoebgogflfebnmejmfbml</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Steem Keychain</td>
      <td>lkcjlnjfpbikmcmbachjpdbijejflpcm</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Nash Extension</td>
      <td>onofpnbbkehpmmoabgpcpmigafmmnjhl</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Hycon Lite Client</td>
      <td>bcopgchhojmggmffilplmbdicgaihlkp</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>ZilPay</td>
      <td>klnaejjgbibmhlephnhpmaofohgkpgkd</td>
    </tr>
    <tr>
      <td>Crypto</td>
      <td>Coin98 Wallet</td>
      <td>aeachknmefphepccionboohckonoeemg</td>
    </tr>
    <tr>
      <td>2FA</td>
      <td>Authenticator</td>
      <td>bhghoamapcdpbohphigoooaddinpkbai</td>
    </tr>
    <tr>
      <td>2FA</td>
      <td>Authy</td>
      <td>gaedmjdfmmahhbjefcbgaolhhanlaolb</td>
    </tr>
    <tr>
      <td>2FA</td>
      <td>EOS Authenticator</td>
      <td>oeljdldpnmdbchonielidgobddffflal</td>
    </tr>
    <tr>
      <td>2FA</td>
      <td>GAuth Authenticator</td>
      <td>ilgcnhelpchnceeipipijaljkblbcobl</td>
    </tr>
    <tr>
      <td>2FA</td>
      <td>Trezor Password Manager</td>
      <td>imloifkgjagghnncjkhggdhalmcnfklk</td>
    </tr>
  </tbody>
</table>

<h2 id="crypto-wallets">Crypto Wallets</h2>

<p>Mars does not just stop at targeting crypto currencies via browser extensions. Many people prefer not to use third-party applications and services to store their digital currency.
Mars will go through various folders looking for specific files related to cryptocurrency.</p>

<p>The first paramter detmerines the path if 0 then it’s under %appdata%  if 1 it’s under %localappdata%
then it search for other wallets with regex <code class="language-plaintext highlighter-rouge">*wallet*.dat</code> under %appdata%</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/36.png" /> 
</p>

<p>Mars have dedicated functionality to target the following crypto wallets:</p>

<table>
  <thead>
    <tr>
      <th>Wallet name</th>
      <th>Wallet folder</th>
      <th>Regex</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Ethereum</td>
      <td>%appdata%\Ethereum\</td>
      <td>keystore</td>
    </tr>
    <tr>
      <td>Electrum</td>
      <td>%appdata%\Electrum\wallets\</td>
      <td>.</td>
    </tr>
    <tr>
      <td>Electrum LTC</td>
      <td>%appdata%\Electrum-LTC\wallets\</td>
      <td>.</td>
    </tr>
    <tr>
      <td>Exodus</td>
      <td>%appdata%\Exodus\</td>
      <td>exodus.conf.json, window-state.json, \Exodus\exodus.wallet\, passphrase.json, seed.seco, info.seco</td>
    </tr>
    <tr>
      <td>Electron Cash</td>
      <td>%appdata%\ElectronCash\wallets\</td>
      <td>default_wallet</td>
    </tr>
    <tr>
      <td>MultiDoge</td>
      <td>%appdata%\MultiDoge\</td>
      <td>multidoge.wallet</td>
    </tr>
    <tr>
      <td>Jaxx</td>
      <td>%appdata%\jaxx\Local Storage\</td>
      <td>file__0.localstorage</td>
    </tr>
    <tr>
      <td>Atomic</td>
      <td>%appdata%\atomic\Local Storage\leveldb\</td>
      <td>000003.log, CURRENT, LOCK, LOG, MANIFEST.000001, 0000*</td>
    </tr>
    <tr>
      <td>Binance</td>
      <td>%appdata%\Binance\</td>
      <td>app-store.json</td>
    </tr>
    <tr>
      <td>Coinomi</td>
      <td>%localappdata%\Coinomi\Coinomi\wallets\</td>
      <td><code class="language-plaintext highlighter-rouge">*.wallet, *.config </code></td>
    </tr>
    <tr>
      <td>Other wallets</td>
      <td>%appdata%</td>
      <td><code class="language-plaintext highlighter-rouge">*wallet*.dat</code></td>
    </tr>
  </tbody>
</table>

<h2 id="system-info">System info</h2>
<p>The malware grabs system info and store it in system.txt file</p>
<ol>
  <li>IP and country</li>
  <li>Working path to EXE file</li>
  <li>Local time and time zone</li>
  <li>Language system</li>
  <li>Language keyboard layout</li>
  <li>Notebook or desktop</li>
  <li>Processor model</li>
  <li>Computer name</li>
  <li>User name</li>
  <li>Domain computer name</li>
  <li>Machine ID</li>
  <li>GUID</li>
  <li>Installed software and their versions</li>
</ol>

<p>Mars althouge takes screenshot and then add all stolen files to a zip file which it will exfiltrate back to the c2 and get loader config.</p>

<h2 id="loader">Loader</h2>

<p>Malware gets loader config as a response after exfiltrating data.
This config looks like  download_URL|An environment variable name and folder name |startup_parameter| .</p>

<p>After pasring the config Mars calls <code class="language-plaintext highlighter-rouge">download_file()</code> function with the url and a path which the file will be saved in . Then calls <code class="language-plaintext highlighter-rouge">ShellExecuteExA()</code> to execute executable with give paramters retrieved from the config.</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/37.png" /> 
</p>
<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/38.png" /> 
</p>

<h1 id="self-deletion">Self Deletion</h1>

<p>Malware gets the path to itself by using <code class="language-plaintext highlighter-rouge">GetModuleFileName()</code> and calls <code class="language-plaintext highlighter-rouge">ShellExecuteExA()</code> which executes the following command</p>

<p><code class="language-plaintext highlighter-rouge">"C:/Windows/System32/cmd.exe" /c timeout /t 5 &amp; del /f / path_To_file &amp; exit</code></p>

<p>After 5 seconds the executable will be deleted.</p>

<p align="center">
<img class="image" src="/assets/malware-analysis/Mars/39.png" /> 
</p>

<h1 id="generalized--idapython-script-using-patterns">Generalized  idapython Script using patterns</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">idautils</span> <span class="p">,</span> <span class="n">idc</span><span class="p">,</span> <span class="n">idaapi</span><span class="p">,</span> <span class="n">ida_search</span><span class="p">,</span> <span class="n">ida_bytes</span><span class="p">,</span> <span class="n">ida_auto</span>
<span class="kn">import</span> <span class="nn">string</span>



<span class="n">seg_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">idaapi</span><span class="p">.</span><span class="n">getseg</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">name</span><span class="p">:</span> <span class="p">(</span><span class="n">idaapi</span><span class="p">.</span><span class="n">getseg</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">start_ea</span><span class="p">,</span> <span class="n">idaapi</span><span class="p">.</span><span class="n">getseg</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">end_ea</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                   <span class="n">idautils</span><span class="p">.</span><span class="n">Segments</span><span class="p">()}</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">seg_mapping</span><span class="p">[</span><span class="mh">0x1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">seg_mapping</span><span class="p">[</span><span class="mh">0x1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    
<span class="k">def</span> <span class="nf">sanitize_string</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">name</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_letters</span><span class="p">])[:</span><span class="mi">20</span><span class="p">].</span><span class="n">capitalize</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">Xor</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="s">""</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="k">def</span> <span class="nf">getData</span> <span class="p">(</span><span class="n">addr</span><span class="p">):</span>
    <span class="n">key_addr</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
    <span class="n">data_addr</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">key_addr</span><span class="p">)</span>
    <span class="n">key_length_addr</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">data_addr</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">key_length_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">key_addr</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">length</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span>  <span class="n">idc</span><span class="p">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">data_addr</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">length</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">key</span> <span class="p">,</span> <span class="n">data</span> <span class="p">,</span><span class="n">length</span>


<span class="k">def</span> <span class="nf">rename_APIs</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span><span class="n">end</span><span class="p">):</span>
    
    <span class="n">func_addr</span> <span class="o">=</span> <span class="n">ea</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">==</span> <span class="s">"push"</span>  <span class="p">)</span><span class="ow">and</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">o_imm</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_strlit_contents</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)).</span><span class="n">decode</span><span class="p">()</span>
            <span class="k">break</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">==</span> <span class="s">"mov"</span>  <span class="ow">and</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">o_reg</span><span class="p">)</span><span class="ow">and</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">o_mem</span><span class="p">))</span> <span class="p">:</span>
            <span class="n">temp_name</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="s">"Str_"</span> <span class="o">==</span> <span class="n">temp_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">temp_name</span><span class="p">[</span><span class="mi">4</span><span class="p">::]</span>
                <span class="k">break</span>        
        <span class="n">ea</span> <span class="o">=</span>  <span class="n">idc</span><span class="p">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>
        
    <span class="n">ea</span> <span class="o">=</span> <span class="n">func_addr</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="o">==</span> <span class="s">"mov"</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">o_mem</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">o_reg</span><span class="p">):</span>
                <span class="n">global_var</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">idc</span><span class="p">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">global_var</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">SN_NOWARN</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">name</span>         
        <span class="n">ea</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">next_head</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">API_resolve</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">):</span>
    <span class="n">Loadlibrarya_addr</span> <span class="o">=</span> <span class="mh">0x0</span>
    <span class="n">GetProcAddress_pattern</span> <span class="o">=</span> <span class="s">"8B 55 ?? 52 8B 45 ?? 8B 4D ??  8B 55 ?? 03 14 ?? 52 E8 ?? ?? ?? ?? 83 C4 ??  85 C0 75 ??"</span>
    <span class="n">GetProcAddress_addr</span> <span class="o">=</span> <span class="n">ida_search</span><span class="p">.</span><span class="n">find_binary</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">GetProcAddress_pattern</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">idc</span><span class="p">.</span><span class="n">SEARCH_DOWN</span><span class="p">)</span>
    <span class="n">GetProcAddress_addr</span> <span class="o">=</span> <span class="n">idaapi</span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">GetProcAddress_addr</span><span class="p">).</span><span class="n">start_ea</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'[*] Traget fucntion found at {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">GetProcAddress_addr</span><span class="p">)))</span>

    <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">idautils</span><span class="p">.</span><span class="n">XrefsTo</span><span class="p">(</span><span class="n">GetProcAddress_addr</span><span class="p">):</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">ref</span><span class="p">.</span><span class="n">frm</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">rename_APIs</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">"Loadlibrarya"</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">Loadlibrarya_addr</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">next_head</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">next_head</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span> <span class="n">end</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>


    <span class="n">new_GetProcAddress_addr</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">next_head</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">next_head</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span> <span class="n">end</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">idautils</span><span class="p">.</span><span class="n">XrefsTo</span><span class="p">(</span><span class="n">new_GetProcAddress_addr</span><span class="p">):</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">ref</span><span class="p">.</span><span class="n">frm</span>
        <span class="n">rename_APIs</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">idautils</span><span class="p">.</span><span class="n">XrefsTo</span><span class="p">(</span><span class="n">Loadlibrarya_addr</span><span class="p">):</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">ref</span><span class="p">.</span><span class="n">frm</span>
        <span class="n">rename_APIs</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

        
<span class="k">def</span> <span class="nf">Strings_resolve</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">):</span>
    <span class="n">xor_pattern</span> <span class="o">=</span> <span class="s">"8b 4d ?? 03 4d ?? 0f be 19 8b 55 ?? 52 e8 ?? ?? ?? ?? 83 c4 ?? 8b c8 8b 45 ?? 33 d2 f7 f1 8b 45 ?? 0f be 0c 10 33 d9 8b 55 ?? 03 55 ?? 88 1a eb be"</span>
    <span class="n">xor_fun_addr</span> <span class="o">=</span> <span class="n">ida_search</span><span class="p">.</span><span class="n">find_binary</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">xor_pattern</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">idc</span><span class="p">.</span><span class="n">SEARCH_DOWN</span><span class="p">)</span>
    <span class="n">xor_fun_addr</span> <span class="o">=</span> <span class="n">idaapi</span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">xor_fun_addr</span><span class="p">).</span><span class="n">start_ea</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'[*] Traget fucntion found at {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">xor_fun_addr</span><span class="p">)))</span>

    <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">idautils</span><span class="p">.</span><span class="n">XrefsTo</span><span class="p">(</span><span class="n">xor_fun_addr</span><span class="p">):</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">ref</span><span class="p">.</span><span class="n">frm</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">getData</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
        <span class="n">decrypt_string</span> <span class="o">=</span> <span class="n">Xor</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
        <span class="n">idc</span><span class="p">.</span><span class="n">set_cmt</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">decrypt_string</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ea</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">next_head</span><span class="p">(</span><span class="n">idc</span><span class="p">.</span><span class="n">next_head</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">end</span><span class="p">),</span><span class="n">end</span><span class="p">)</span>
        <span class="n">global_var</span> <span class="o">=</span> <span class="n">idc</span><span class="p">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">idc</span><span class="p">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">global_var</span><span class="p">,</span> <span class="s">"Str_"</span> <span class="o">+</span> <span class="n">sanitize_string</span><span class="p">(</span><span class="n">decrypt_string</span><span class="p">),</span> <span class="n">SN_NOWARN</span><span class="p">)</span>
        
<span class="k">def</span> <span class="nf">Anit_Reverse</span><span class="p">():</span>
    <span class="n">ea</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">ea</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ida_search</span><span class="p">.</span><span class="n">find_binary</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">idc</span><span class="p">.</span><span class="n">BADADDR</span><span class="p">,</span> <span class="s">"74 ? 75 ?"</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">idc</span><span class="p">.</span><span class="n">SEARCH_NEXT</span> <span class="o">|</span> <span class="n">idc</span><span class="p">.</span><span class="n">SEARCH_DOWN</span><span class="p">),</span>
                 <span class="c1"># JZ / JNZ
</span>                 <span class="n">ida_search</span><span class="p">.</span><span class="n">find_binary</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">idc</span><span class="p">.</span><span class="n">BADADDR</span><span class="p">,</span> <span class="s">"75 ? 74 ?"</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>
                                        <span class="n">idc</span><span class="p">.</span><span class="n">SEARCH_NEXT</span> <span class="o">|</span> <span class="n">idc</span><span class="p">.</span><span class="n">SEARCH_DOWN</span><span class="p">))</span>  <span class="c1"># JNZ / JZ
</span>        <span class="k">if</span> <span class="n">ea</span> <span class="o">==</span> <span class="n">idc</span><span class="p">.</span><span class="n">BADADDR</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">idc</span><span class="p">.</span><span class="n">patch_byte</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mh">0xEB</span><span class="p">)</span>
        <span class="n">idc</span><span class="p">.</span><span class="n">patch_byte</span><span class="p">(</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">)</span>
        <span class="n">idc</span><span class="p">.</span><span class="n">patch_byte</span><span class="p">(</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">)</span>
        <span class="n">idc</span><span class="p">.</span><span class="n">patch_byte</span><span class="p">(</span><span class="n">ea</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">Anit_Reverse</span><span class="p">()</span>
    <span class="n">Strings_resolve</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>
    <span class="n">API_resolve</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>

<span class="n">main</span><span class="p">()</span>

</code></pre></div></div>
<p>for more Idapython scripts check my <a href="https://github.com/X-Junior/Malware-IDAPython-Scripts/">repo</a> .</p>

<h1 id="iocs">IOCs</h1>

<ul>
  <li>Hashes:
    <ol>
      <li>md5 : 880924E5583978C615DD03FF89648093</li>
      <li>sha1 : EF759F6ECA63D6B05A7B6E395DF3571C9703278B</li>
      <li>sha256 : 4bcff4386ce8fadce358ef0dbe90f8d5aa7b4c7aec93fca2e605ca2cbc52218b</li>
      <li>imphash : 4E06C011D59529BFF8E1F1C88254B928</li>
      <li>ssdeep : 3072:U/E8k9fjpIg+zNch12KbAwSaSMtmSu4/bVBt4b8EG:U/E8k9bwz6/tJc/4xM8EG</li>
    </ol>
  </li>
  <li>Mutex : 92550737836278980100</li>
  <li>Files:
    <ol>
      <li>C:\ProgramData\freebl3.dll</li>
      <li>C:\ProgramData\mozglue.dll</li>
      <li>C:\ProgramData\msvcp140.dll</li>
      <li>C:\ProgramData\nss3.dll</li>
      <li>C:\ProgramData\softokn3.dll</li>
      <li>C:\ProgramData\vcruntime140.dll</li>
    </ol>
  </li>
  <li>C2 Server : 194.87.218.39</li>
  <li>C2 Domains:
    <ol>
      <li>http://194[.]87[.]218[.]39/request</li>
      <li>http://194[.]87[.]218[.]39/RyC66VfSGP[.]php</li>
    </ol>
  </li>
</ul>

<h1 id="yara">YARA</h1>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rule</span> <span class="n">Mars_Stealer</span><span class="p">:</span> <span class="n">Mars</span> <span class="n">Stealer</span>
<span class="p">{</span>
    <span class="n">meta</span><span class="p">:</span>
        <span class="n">Author</span> <span class="o">=</span> <span class="s">"X__Junior"</span>
        <span class="n">Description</span> <span class="o">=</span> <span class="s">"Mars Stealer v8 Detection"</span>

    <span class="n">strings</span><span class="p">:</span>
        <span class="err">$</span><span class="n">xor</span> <span class="o">=</span><span class="p">{</span><span class="mi">8</span><span class="n">b</span> <span class="mi">4</span><span class="n">d</span> <span class="err">??</span> <span class="mi">03</span> <span class="mi">4</span><span class="n">d</span> <span class="err">??</span> <span class="mi">0</span><span class="n">f</span> <span class="n">be</span> <span class="mi">19</span> <span class="mi">8</span><span class="n">b</span> <span class="mi">55</span> <span class="err">??</span> <span class="mi">52</span> <span class="n">e8</span> <span class="err">??</span> <span class="err">??</span> <span class="err">??</span> <span class="err">??</span> <span class="mi">83</span> <span class="n">c4</span> <span class="err">??</span> <span class="mi">8</span><span class="n">b</span> <span class="n">c8</span> <span class="mi">8</span><span class="n">b</span> <span class="mi">45</span> <span class="err">??</span> <span class="mi">33</span> <span class="n">d2</span> <span class="n">f7</span> <span class="n">f1</span> <span class="mi">8</span><span class="n">b</span> <span class="mi">45</span> <span class="err">??</span> <span class="mi">0</span><span class="n">f</span> <span class="n">be</span> <span class="mi">0</span><span class="n">c</span> <span class="mi">10</span> <span class="mi">33</span> <span class="n">d9</span> <span class="mi">8</span><span class="n">b</span> <span class="mi">55</span> <span class="err">??</span> <span class="mi">03</span> <span class="mi">55</span> <span class="err">??</span> <span class="mi">88</span> <span class="mi">1</span><span class="n">a</span> <span class="n">eb</span> <span class="n">be</span><span class="p">}</span>
        <span class="err">$</span><span class="n">debug</span> <span class="o">=</span> <span class="p">{</span><span class="mi">64</span> <span class="n">A1</span> <span class="mi">30</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">80</span> <span class="mi">78</span> <span class="mi">02</span> <span class="mi">00</span><span class="p">}</span>
	<span class="err">$</span><span class="n">thread_func</span> <span class="o">=</span> <span class="p">{</span><span class="n">B8</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>   <span class="mi">85</span> <span class="err">??</span>  <span class="mi">74</span> <span class="err">??</span> <span class="n">E8</span> <span class="err">??</span> <span class="err">??</span> <span class="err">??</span> <span class="err">??</span> <span class="mi">85</span> <span class="err">??</span> <span class="mi">74</span> <span class="err">??</span> <span class="mi">6</span><span class="n">A</span> <span class="mi">00</span> <span class="n">FF</span> <span class="err">??</span> <span class="err">??</span> <span class="err">??</span> <span class="err">??</span> <span class="err">??</span> <span class="mi">6</span><span class="n">A</span> <span class="err">??</span> <span class="n">FF</span> <span class="err">??</span> <span class="err">??</span> <span class="err">??</span> <span class="err">??</span> <span class="err">??</span> <span class="n">EB</span> <span class="err">??</span><span class="p">}</span>

        <span class="err">$</span><span class="n">api1</span> <span class="o">=</span> <span class="s">"LocalAlloc"</span> <span class="nb">ascii</span>
        <span class="err">$</span><span class="n">api2</span> <span class="o">=</span> <span class="s">"VirtualProtect"</span> <span class="nb">ascii</span>
        <span class="err">$</span><span class="n">api3</span> <span class="o">=</span> <span class="s">"SetFileTime"</span> <span class="nb">ascii</span>
        <span class="err">$</span><span class="n">api4</span> <span class="o">=</span> <span class="s">"LocalFileTimeToFileTime"</span> <span class="nb">ascii</span>
        <span class="err">$</span><span class="n">api5</span> <span class="o">=</span> <span class="s">"HeapFree"</span> <span class="nb">ascii</span>
        <span class="err">$</span><span class="n">api6</span> <span class="o">=</span> <span class="s">"VirtualFree"</span> <span class="nb">ascii</span>
        <span class="err">$</span><span class="n">api7</span> <span class="o">=</span> <span class="s">"VirtualAlloc"</span> <span class="nb">ascii</span>

        <span class="err">$</span><span class="n">s1</span> <span class="o">=</span> <span class="s">"DPAPI"</span> <span class="nb">ascii</span>
        <span class="err">$</span><span class="n">s2</span> <span class="o">=</span> <span class="s">"memset"</span> <span class="nb">ascii</span>
        <span class="err">$</span><span class="n">s3</span> <span class="o">=</span> <span class="s">"msvcrt.dll"</span> <span class="nb">ascii</span>
        <span class="err">$</span><span class="n">s4</span> <span class="o">=</span> <span class="s">"_mbsnbcpy"</span> <span class="nb">ascii</span>
        <span class="err">$</span><span class="n">s5</span> <span class="o">=</span> <span class="s">"_mbsstr"</span> <span class="nb">ascii</span>

    <span class="n">condition</span><span class="p">:</span>
        <span class="n">uint16</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x5A4D</span> <span class="ow">and</span> <span class="mi">2</span> <span class="n">of</span><span class="p">(</span><span class="err">$</span><span class="n">api</span><span class="o">*</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">3</span> <span class="n">of</span><span class="p">(</span><span class="err">$</span><span class="n">s</span><span class="o">*</span><span class="p">)</span>  <span class="ow">and</span> <span class="err">$</span><span class="n">debug</span>  <span class="ow">and</span> <span class="err">$</span><span class="n">xor</span>  <span class="ow">and</span> <span class="err">$</span><span class="n">thread_func</span>

<span class="p">}</span>
</code></pre></div></div>
<h1 id="conclusion">Conclusion</h1>

<p>The last sample of mars i saw came packed with custom packer , easy to unpack with x32dbg by just setting a breakpoint on <code class="language-plaintext highlighter-rouge">VirtualAlloc()</code> , nothing else was changed except for the C2 .</p>

<h1 id="references">References</h1>
<ul>
  <li>Great analysis of the previous version <a href="https://3xp0rt.com/posts/mars-stealer">https://3xp0rt.com/posts/mars-stealer</a></li>
  <li><a href="https://lp.cyberark.com/rs/316-CZP-275/images/CyberArk-Labs-Racoon-Malware-wp.pdf">https://lp.cyberark.com/rs/316-CZP-275/images/CyberArk-Labs-Racoon-Malware-wp.pdf</a></li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#stealer" class="page__taxonomy-item p-category" rel="tag">Stealer</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#malware-analysis" class="page__taxonomy-item" rel="tag">Malware Analysis</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2022-05-19T00:00:00+02:00">May 19, 2022</time></p>
        
      </footer>

      

      
    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 Mohamed Ashraf. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
